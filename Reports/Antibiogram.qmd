---
format:
  html:
    self-contained: true
    css: ["report.css"]
    theme: cosmo
execute:
  echo: false
  warning: false
page-layout: custom
params:
  vwidth: 1120
  filters: null,
  tableRows: 0,
  controls: null,
  bp: null
---

```{r setup, include=FALSE}
library(shiny)
library(dplyr)

source("report_utils.R")
source("ui_utils.R")

filters <- params$filters
controls <- params$controls
low_counts <- readLines("low_counts_flag.txt", warn = FALSE)

# Filter summary to go at the top of each page
report_summary <- get_report_summary(filters)

table_legend <- NULL

icon("square") # Needed for icons in the legends to render

if (params$controls$abType == "Simplified") {
  table_legend <- get_simplified_ab_legend()
} else if (params$controls$showColors) {
  table_legend <- get_classic_ab_legend()
}
```


<!-- First Page -->
<div class="page-section">

<img src="logo.png" alt="AMR logo" class="logo-img" />

<hr class="blue-hr">

<h3>Antibiogram Report</h3>

```{r ab-page-summary, echo=FALSE, results='asis'}
report_summary
```


```{r ab-summary-vars, echo=FALSE}

row_text <- ifelse(params$tableRows > controls$numAb, paste("top", controls$numAb), "all")
aggregate_text <- ifelse(controls$aggByGenus, "Bacteria are aggregated by genus.", "")
pair_text <- ifelse(controls$yVar == "Microorganism", "organism", "source")
shown_text <- dplyr::case_when(
  controls$lowCounts == "Exclude" ~ "excluded",
  controls$showColors == TRUE ~ "shown",
  TRUE ~ "shown but not colored"
)

```


An antibiogram is a cumulative report that summarizes the percentage of bacterial isolates susceptible to each antimicrobial.
The antibiogram is shown for `r row_text` `r tolower(controls$yVar)`s sorted by `r tolower(controls$sortBy)`.
`r aggregate_text` Antimicrobials are divided by class with dashed vertical lines.

Each cell shows the percentage of isolates interpreted as susceptible for a given `r pair_text`窶電rug pair.
`r tools::toTitleCase(pair_text)`窶電rug combinations with fewer than 30 isolates tested are `r shown_text`<span id="fnref-1"><a href="#fn-1" class="footnote-arrow"><sup>1</sup></a></span>.


<!-- Percentages - Combined or Gram Negative -->

```{r ab-table1, echo=FALSE, results='asis'}

if (file.exists("antibiogram_table.png")) {
  div(
    if (file.exists("antibiogram_table2.png")) {
      h4("Gram-Negative", style="text-align: center;")
    },
    div(
      style="display: flex; justify-content: center;",
      img(src="antibiogram_table.png", class="table-img")
    )
  )
}
```


<!-- Gram Positive -->

```{r ab-table2, echo=FALSE, results='asis'}
if (file.exists("antibiogram_table2.png")) {
  div(
    h4("Gram-Positive", style="text-align: center;"),
    div(
      style="display: flex; justify-content: center;",
      img(src="antibiogram_table2.png", class="table-img")
    )
  )
}
```

`r table_legend`


<div class="footnotes">

<span class="footnote-header">
Footnotes
</span>

<div id="fn-1" class="custom-footnote">

<a href="#fnref-1" class="footnote-arrow">1.</a>
The percent susceptible is calculated over all isolates tested for against the antimicrobial. The complement (100 - percent susceptible) is not the same as the percent resistant as there are other interpretation categories (susceptible-dose dependent, intermediate, resistant, and not interpretable).
</div>

</div>


<!-- Second Page -->

<div class="page-break"></div>

<div class="page-section">

<hr class="blue-hr">

<h3>Number of Isolates Tested</h3>

```{r isolate-page-summary, echo=FALSE, results='asis'}
report_summary
```

The table is shown for `r ifelse(params$tableRows > controls$numAb, paste("top", controls$numAb), "all")` `r tolower(controls$yVar)`s sorted by `r tolower(controls$sortBy)`.
`r aggregate_text`

Each cell shows the number of isolates interpreted as susceptible over the total number of isolates tested for a given `r pair_text`窶電rug pair.
`r tools::toTitleCase(pair_text)`窶電rug combinations with fewer than 30 isolates tested are `r shown_text`.

<!-- Isolates - Combined or Gram Negative -->

```{r isolate-table1, echo=FALSE, results='asis'}
if (file.exists("isolate_table.png")) {
  div(
    if (file.exists("isolate_table2.png")) {
      h4("Gram-Negative", style="text-align: center;")
    },
    div(
      style="display: flex; justify-content: center;",
      img(src="isolate_table.png", class="table-img")
    )
  )
}
```


<!-- Gram Positive -->

```{r isolate-table2, echo=FALSE, results='asis'}
if (file.exists("isolate_table2.png")) {
  div(
    h4("Gram-Positive", style="text-align: center;"),
    div(
      style="display: flex; justify-content: center;",
      img(src="isolate_table2.png", class="table-img")
    )
  )
}
```

`r table_legend`

</div>

<!-- Third Page -->

<div class="page-break"></div>

<div class="page-section">

<hr class="blue-hr">

<h3>Percent Susceptible 95% Confidence Interval</h3>

```{r ci-page-summary, echo=FALSE, results='asis'}
report_summary
```

<!-- Isolates - Combined or Gram Negative -->

```{r ci-table1, echo=FALSE, results='asis'}
if (file.exists("ci_table.png")) {
  div(
    if (file.exists("ci_table2.png")) {
      h4("Gram-Negative", style="text-align: center;")
    },
    div(
      style="display: flex; justify-content: center;",
      img(src="ci_table.png", class="table-img")
    )
  )
}
```


<!-- Gram Positive -->

```{r ci-table2, echo=FALSE, results='asis'}
if (file.exists("ci_table2.png")) {
  div(
    h4("Gram-Positive", style="text-align: center;"),
    div(
      style="display: flex; justify-content: center;",
      img(src="ci_table2.png", class="table-img")
    )
  )
}
```

`r table_legend`

</div>

<!-- Fourth Page -->

<div class="page-break"></div>

<div class="page-section">

<hr class="blue-hr">

<h3>Background Information</h3>

Antibiograms are a summary of antimicrobial susceptibility data, showing the percentage of susceptibility across pathogen and antimicrobial drug combinations. Antibiograms may be useful for guiding empiric antimicrobial therapy, in conjunction with information on the likely pathogen, infected body site, and antimicrobial pharmacokinetics and pharmacodynamics. They can also assist with antimicrobial resistance surveillance. When interpreting an antibiogram, consider the following:

1. The precision of the susceptibility percentage estimate is related to the number of bacterial isolates tested. In general, it is recommended to only estimate the susceptibility percentage for pathogen-drug combinations that are represented by at least 30 isolates. This results in a minimum precision of 15 percentage points, meaning that an estimate of 50% susceptibility could reflect a true susceptibility percentage of 35% to 65%. Precision is greater with larger sample sizes and at the extreme percentages (e.g., 90% susceptibility has a greater precision than 50%).
2. Antibiograms should only include one isolate per patient of each bacterial species. Including more than one isolate per patient can bias the susceptibility percentage since the same isolate may be isolated multiple times from a patient or the isolate susceptibilities from a single patient may be correlated.
3. Antimicrobials that are routinely tested will produce the most accurate susceptibility percentage. Antimicrobials that are not tested on every isolate are likely to have biased susceptibility percentages, often towards higher levels of resistance, because these antimicrobials may only be tested on isolates that are resistant to routine antimicrobials.
4. Costs of diagnostic testing can result in antibiogram bias. For example, in veterinary medicine, culture and susceptibility test costs are paid by animal owners. Overall, only a small percentage of infected animals have a culture and susceptibility test and animals with infections that did not respond to empiric therapy may be more likely to have a culture performed. This can bias the data, likely towards lower susceptibility percentages.
5. There is not a standard susceptibility percentage that is considered acceptable for empiric therapy. The expected susceptibility percentage should be considered together with patient factors and good antimicrobial stewardship practices. A suggestion is that susceptibility greater than 80% is appropriate for empiric antimicrobial selection and lower than 60% would be a poor choice for empiric therapy. 5. Breakpoints change as additional information about antimicrobial pharmacokinetics and pharmacodynamics and clinical outcomes becomes available. If a breakpoint shifts outside the range of typically tested antimicrobial concentrations, then some MIC values may not be interpretable. If a large percentage of MICs are not interpretable for a specific antimicrobial, source, host species, and microorganism combination, then the percentage of susceptibility will be biased. This is particularly important if only small or large MICs are uninterpretable, leading to artificially low or high susceptibility percentages, respectively. For example, if the lowest concentration that a lab routinely tests an antibiotic at is 2 and the susceptibility breakpoint later changes to 1, the percentage of susceptibility will be biased towards decreased susceptibility, because the susceptibility of all of the previous results that were <= 2 cannot be interpreted, but any result with a value >2 will be classified as resistant.


<img src="report-bp-example.png" alt="Breakpoint diagram" id="bp-img"/>

This antibiogram was generated with AMR Visualizer, an RShiny App [insert citation].

</div>
